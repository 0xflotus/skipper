<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Ingress Usage - Skipper</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../..">Skipper</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../..">Introduction</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Reference <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../reference/filters/">Filters</a>
</li>
                                    
<li >
    <a href="../../reference/predicates/">Predicates</a>
</li>
                                    
<li >
    <a href="../../reference/scripts/">Scripts</a>
</li>
                                    
<li >
    <a href="../../reference/plugins/">Plugins</a>
</li>
                                    
<li >
    <a href="../../reference/architecture/">Architecture</a>
</li>
                                    
<li >
    <a href="../../reference/development/">Development</a>
</li>
                                    
<li >
    <a href="../../tutorials/video-howto-build/">Video - How to build</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Data Clients</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../data-clients/eskip-file/">Eskip File</a>
</li>
            
<li >
    <a href="../../data-clients/etcd/">Etcd</a>
</li>
            
<li >
    <a href="../../data-clients/kubernetes/">Kubernetes</a>
</li>
            
<li >
    <a href="../../data-clients/innkeeper/">Innkeeper API</a>
</li>
            
<li >
    <a href="../../data-clients/route-string/">Route String</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Operation</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../operation/deployment/">Deployment</a>
</li>
            
<li >
    <a href="../../operation/operation/">Operation</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Kubernetes <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../ingress-controller/">Ingress Controller Deployment</a>
</li>
                                    
<li class="active">
    <a href="./">Ingress Usage</a>
</li>
                                    
<li >
    <a href="../ingress-backends/">Ingress Backends</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../ingress-controller/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../ingress-backends/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#skipper-ingress-usage">Skipper Ingress Usage</a></li>
            <li><a href="#skipper-ingress-annotations">Skipper Ingress Annotations</a></li>
            <li><a href="#supported-service-types">Supported Service types</a></li>
        <li class="main "><a href="#basics">Basics</a></li>
            <li><a href="#http-host-header-routing">HTTP Host header routing</a></li>
            <li><a href="#ingress-path-handling">Ingress path handling</a></li>
            <li><a href="#filters-and-predicates">Filters and Predicates</a></li>
            <li><a href="#custom-routes">Custom Routes</a></li>
        <li class="main "><a href="#filters-basic-http-manipulations">Filters - Basic HTTP manipulations</a></li>
            <li><a href="#add-a-request-header">Add a request Header</a></li>
            <li><a href="#add-a-response-header">Add a response Header</a></li>
            <li><a href="#enable-gzip">Enable gzip</a></li>
            <li><a href="#set-the-path">Set the Path</a></li>
            <li><a href="#modify-path">Modify Path</a></li>
            <li><a href="#set-the-querystring">Set the Querystring</a></li>
            <li><a href="#redirect">Redirect</a></li>
            <li><a href="#cookies">Cookies</a></li>
            <li><a href="#authorization">Authorization</a></li>
            <li><a href="#diagnosis-throttling-bandwidth-latency">Diagnosis - Throttling Bandwidth - Latency</a></li>
            <li><a href="#flow-id-to-trace-request-flows">Flow Id to trace request flows</a></li>
        <li class="main "><a href="#filters-reliability-features">Filters - reliability features</a></li>
            <li><a href="#circuitbreaker">Circuitbreaker</a></li>
            <li><a href="#ratelimits">Ratelimits</a></li>
            <li><a href="#shadow-traffic">Shadow Traffic</a></li>
        <li class="main "><a href="#predicates">Predicates</a></li>
            <li><a href="#feature-toggle">Feature Toggle</a></li>
            <li><a href="#ip-whitelisting">IP Whitelisting</a></li>
            <li><a href="#ab-test">A/B test</a></li>
        <li class="main "><a href="#blue-green-deployments">Blue-Green deployments</a></li>
        <li class="main "><a href="#chaining-filters-and-predicates">Chaining Filters and Predicates</a></li>
        <li class="main "><a href="#controlling-https-redirect">Controlling HTTPS redirect</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="skipper-ingress-usage">Skipper Ingress Usage</h1>
<p>This documentation is meant for people deploying to Kubernetes
Clusters and describes to use Ingress and low level and high level
features Skipper provides</p>
<h2 id="skipper-ingress-annotations">Skipper Ingress Annotations</h2>
<table>
<thead>
<tr>
<th>Annotation</th>
<th>example data</th>
<th>usage</th>
</tr>
</thead>
<tbody>
<tr>
<td>zalando.org/backend-weights</td>
<td><code>{"my-app-1": 80, "my-app-2": 20}</code></td>
<td>blue-green deployments</td>
</tr>
<tr>
<td>zalando.org/skipper-filter</td>
<td><code>consecutiveBreaker(15)</code></td>
<td>arbitrary filters</td>
</tr>
<tr>
<td>zalando.org/skipper-predicate</td>
<td><code>QueryParam("version", "^alpha$")</code></td>
<td>arbitrary predicates</td>
</tr>
<tr>
<td>zalando.org/skipper-routes</td>
<td><code>Method("OPTIONS") -&gt; status(200) -&gt; &lt;shunt&gt;</code></td>
<td>extra custom routes</td>
</tr>
<tr>
<td>zalando.org/ratelimit</td>
<td><code>ratelimit(50, "1m")</code></td>
<td>deprecated, use zalando.org/skipper-filter instead</td>
</tr>
<tr>
<td>zalando.org/skipper-ingress-redirect</td>
<td><code>true</code></td>
<td>change the default HTTPS redirect behavior for specific ingresses (true/false)</td>
</tr>
<tr>
<td>zalando.org/skipper-ingress-redirect-code</td>
<td><code>301</code></td>
<td>change the default HTTPS redirect code for specific ingresses</td>
</tr>
</tbody>
</table>
<h2 id="supported-service-types">Supported Service types</h2>
<p>Ingress backend definitions are services, which have different
<a href="https://kubernetes.io/docs/concepts/services-networking/service/#publishing-services---service-types">service types</a>.</p>
<table>
<thead>
<tr>
<th>Service type</th>
<th>supported</th>
<th>workaround</th>
</tr>
</thead>
<tbody>
<tr>
<td>ClusterIP</td>
<td>yes</td>
<td>---</td>
</tr>
<tr>
<td>NodePort</td>
<td>yes</td>
<td>---</td>
</tr>
<tr>
<td>ExternalName</td>
<td>no, <a href="https://github.com/zalando/skipper/issues/549">related issue</a></td>
<td><a href="../dataclients/route-string/#proxy-to-a-given-url">use deployment with routestring</a></td>
</tr>
<tr>
<td>LoadBalancer</td>
<td>no</td>
<td>it should not, because Kubernetes cloud-controller-manager will maintain it</td>
</tr>
</tbody>
</table>
<h1 id="basics">Basics</h1>
<h2 id="http-host-header-routing">HTTP Host header routing</h2>
<p>HTTP host header is defined within the rules <code>host</code> section and this
route will match by http <code>Host: app-default.example.org</code> and route to
endpoints selected by the Kubernetes service <code>app-svc</code> on port <code>80</code>.</p>
<pre><code>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: app
spec:
  rules:
  - host: app-default.example.org
    http:
      paths:
      - backend:
          serviceName: app-svc
          servicePort: 80
</code></pre>
<p>To have 2 routes with different <code>Host</code> headers serving the same
backends, you have to specify 2 entries in the rules section, as
Kubernetes defined the ingress spec. This is often used in cases of
migrations from one domain to another one or migrations to or from
bare metal datacenters to cloud providers or inter cloud or intra
cloud providers migrations. Examples are AWS account migration, AWS to
GCP migration, GCP to bare metal migration or bare metal to Alibaba
Cloud migration.</p>
<pre><code>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: app
spec:
  rules:
  - host: app-default.example.org
    http:
      paths:
      - backend:
          serviceName: app-svc
          servicePort: 80
  - host: foo.example.org
    http:
      paths:
      - backend:
          serviceName: app-svc
          servicePort: 80
</code></pre>
<h2 id="ingress-path-handling">Ingress path handling</h2>
<p>Ingress paths can be interpreted in four different modes:</p>
<ol>
<li>based on the kubernetes ingress specification</li>
<li>as plain regular expression</li>
<li>as a path prefix</li>
</ol>
<p>The default is the kubernetes ingress mode. It can be changed by a startup option
to any of the other modes, and the individual ingress rules can also override the
default behavior with the zalando.org/skipper-ingress-path-mode annotation.</p>
<p>E.g.:</p>
<pre><code>zalando.org/skipper-ingress-path-mode: path-prefix
</code></pre>
<h3 id="kubernetes-ingress-specification-base-path">Kubernetes ingress specification base path</h3>
<p>By default, the ingress path is interpreted as a regular expression with a
mandatory leading "/", and is automatically prepended by a "^" control character,
enforcing that the path has to be at the start of the incoming request path.</p>
<h3 id="plain-regular-expression">Plain regular expression</h3>
<p>When the path mode is set to "path-regexp", the ingress path is interpreted similar
to the default kubernetes ingress specification way, but is not prepended by the "^"
control character.</p>
<h3 id="path-prefix">Path prefix</h3>
<p>When the path mode is set to "path-prefix", the ingress path is not a regular
expression. As an example, "/foo/bar" will match "/foo/bar" or "/foo/bar/baz", but
won't match "/foo/barooz".</p>
<p>When PathPrefix is used, the path matching becomes deterministic when
a request could match more than one ingress routes otherwise.</p>
<p>In PathPrefix mode, when a Path or PathSubtree predicate is set in an
annotation, the predicate in the annotation takes precedence over the normal ingress
path.</p>
<h2 id="filters-and-predicates">Filters and Predicates</h2>
<ul>
<li><strong>Filters</strong> can manipulate http data, which is not possible in the ingress spec.</li>
<li><strong>Predicates</strong> change the route matching, beyond normal ingress definitions</li>
</ul>
<p>This example shows how to add predicates and filters:</p>
<pre><code>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    zalando.org/skipper-predicate: predicate1 &amp;&amp; predicate2 &amp;&amp; .. &amp;&amp; predicateN
    zalando.org/skipper-filter: filter1 -&gt; filter2 -&gt; .. -&gt; filterN
  name: app
spec:
  rules:
  - host: app-default.example.org
    http:
      paths:
      - backend:
          serviceName: app-svc
          servicePort: 80
</code></pre>
<h2 id="custom-routes">Custom Routes</h2>
<p>Custom routes is a way of extending the default routes configured for
an ingress resource.</p>
<p>Sometimes you just want to return a header, redirect or even static
html content. You can return from skipper without doing a proxy call
to a backend, if you end your filter chain with <code>&lt;shunt&gt;</code>. The use of
<code>&lt;shunt&gt;</code> recommends the use in combination with <code>status()</code> filter, to
not respond with the default http code, which defaults to 404.  To
match your custom route with higher priority than your ingress you
also have to add another predicate, for example the <a href="/predicates/#method">Method("GET")
predicate</a> to match the route with higher
priority.</p>
<p>Custom routes specified in ingress will always add the <code>Host()</code>
<a href="/predicates/#host">predicate</a> to match the host header specified in
the ingress <code>rules:</code>. If there is a <code>path:</code> definition in your
ingress, then it will be based on the skipper command line parameter
<code>-kubernetes-path-mode</code> set one of theses predicates:</p>
<ul>
<li><a href="https://opensource.zalando.com/skipper/predicates/#path">Path()</a></li>
<li><a href="https://opensource.zalando.com/skipper/predicates/#pathsubtree">PathSubtree()</a></li>
<li><a href="https://opensource.zalando.com/skipper/predicates/#pathregexp">PathRegexp()</a></li>
</ul>
<h3 id="return-static-content">Return static content</h3>
<p>The following example sets a response header <code>X: bar</code>, a response body
<code>&lt;html&gt;&lt;body&gt;hello&lt;/body&gt;&lt;/html&gt;</code> and respond from the ingress
directly with a HTTP status code 200:</p>
<pre><code>zalando.org/skipper-routes: |
  Path("/") -&gt; setResponseHeader("X", "bar") -&gt; inlineContent("&lt;html&gt;&lt;body&gt;hello&lt;/body&gt;&lt;/html&gt;") -&gt; status(200) -&gt; &lt;shunt&gt;
</code></pre>
<p>Keep in mind that you need a valid backend definition to backends
which are available, otherwise Skipper would not accept the entire
route definition from the ingress object for safety reasons.</p>
<h3 id="cors-example">CORS example</h3>
<p>This example shows how to add a custom route for handling <code>OPTIONS</code> requests.</p>
<pre><code class="yaml">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    zalando.org/skipper-routes: |
      Method(&quot;OPTIONS&quot;) -&gt;
      setResponseHeader(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;) -&gt;
      setResponseHeader(&quot;Access-Control-Allow-Methods&quot;, &quot;GET, OPTIONS&quot;) -&gt;
      setResponseHeader(&quot;Access-Control-Allow-Headers&quot;, &quot;Authorization&quot;) -&gt;
      status(200) -&gt; &lt;shunt&gt;
  name: app
spec:
  rules:
  - host: app-default.example.org
    http:
      paths:
      - backend:
          serviceName: app-svc
          servicePort: 80
</code></pre>

<p>This will generate a custom route for the ingress which looks like this:</p>
<pre><code>Host(/^app-default[.]example[.]org$/) &amp;&amp; Method(&quot;OPTIONS&quot;) -&gt;
  setResponseHeader(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;) -&gt;
  setResponseHeader(&quot;Access-Control-Allow-Methods&quot;, &quot;GET, OPTIONS&quot;) -&gt;
  setResponseHeader(&quot;Access-Control-Allow-Headers&quot;, &quot;Authorization&quot;) -&gt;
  status(200) -&gt; &lt;shunt&gt;
</code></pre>

<h3 id="multiple-routes">Multiple routes</h3>
<p>You can also set multiple routes, but you have to set the names of the
route as defined in eskip:</p>
<pre><code>zalando.org/skipper-routes: |
  routename1: Path("/") -&gt; localRatelimit(2, "1h") -&gt; inlineContent("A") -&gt; status(200) -&gt; &lt;shunt&gt;;
  routename2: Path("/foo") -&gt; localRatelimit(5, "1h") -&gt; inlineContent("B") -&gt; status(200) -&gt; &lt;shunt&gt;;
</code></pre>
<p>Make sure the <code>;</code> semicolon is used to terminate the routes, if you
use multiple routes definitions.</p>
<h1 id="filters-basic-http-manipulations">Filters - Basic HTTP manipulations</h1>
<p>HTTP manipulations are done by using skipper filters. Changes can be
done in the request path, meaning request to your backend or in the
response path to the client, which made the request.</p>
<p>The following examples can be used within <code>zalando.org/skipper-filter</code>
annotation.</p>
<h2 id="add-a-request-header">Add a request Header</h2>
<p>Add a HTTP header in the request path to your backend.</p>
<pre><code>setRequestHeader("X-Foo", "bar")
</code></pre>
<h2 id="add-a-response-header">Add a response Header</h2>
<p>Add a HTTP header in the response path of your clients.</p>
<pre><code>setResponseHeader("X-Foo", "bar")
</code></pre>
<h2 id="enable-gzip">Enable gzip</h2>
<p>Compress responses with gzip.</p>
<pre><code>compress() // compress all valid MIME types
compress("text/html") // only compress HTML files
compress(9, "text/html") // control the level of compression, 1 = fastest, 9 = best compression, 0 = no compression
</code></pre>
<h2 id="set-the-path">Set the Path</h2>
<p>Change the path in the request path to your backend to <code>/newPath/</code>.</p>
<pre><code>setPath("/newPath/")
</code></pre>
<h2 id="modify-path">Modify Path</h2>
<p>Modify the path in the request path from <code>/api/foo</code> to your backend to <code>/foo</code>.</p>
<pre><code>modPath("^/api/", "/")
</code></pre>
<h2 id="set-the-querystring">Set the Querystring</h2>
<p>Set the Querystring in the request path to your backend to <code>?text=godoc%20skipper</code>.</p>
<pre><code>setQuery("text", "godoc skipper")
</code></pre>
<h2 id="redirect">Redirect</h2>
<p>Create a redirect with HTTP code 301 to https://foo.example.org/.</p>
<pre><code>redirectTo(301, "https://foo.example.org/")
</code></pre>
<h2 id="cookies">Cookies</h2>
<p>Set a Cookie in the request path to your backend.</p>
<pre><code>requestCookie("test-session", "abc")
</code></pre>
<p>Set a Cookie in the response path of your clients.</p>
<pre><code>responseCookie("test-session", "abc", 31536000)
responseCookie("test-session", "abc", 31536000, "change-only")

// response cookie without HttpOnly:
jsCookie("test-session-info", "abc-debug", 31536000, "change-only")
</code></pre>
<h2 id="authorization">Authorization</h2>
<p>Our <a href="https://godoc.org/github.com/zalando/skipper/filters/auth">filter auth godoc</a>
shows how to use filters for authorization.</p>
<h3 id="basic-auth">Basic Auth</h3>
<pre><code>% htpasswd -nbm myName myPassword

basicAuth("/path/to/htpasswd")
basicAuth("/path/to/htpasswd", "My Website")
</code></pre>
<h3 id="bearer-token-oauthjwt">Bearer Token (OAuth/JWT)</h3>
<p>OAuth2/JWT tokens can be validated and allowed based on different
content of the token. Please check the filter documentation for that:</p>
<ul>
<li><a href="/filters/#oauthtokeninfoanyscope">oauthTokeninfoAnyScope</a></li>
<li><a href="/filters/#oauthtokeninfoallscope">oauthTokeninfoAllScope</a></li>
<li><a href="/filters/#oauthtokeninfoanykv">oauthTokeninfoAnyKV</a></li>
<li><a href="/filters/#oauthtokeninfoallkv">oauthTokeninfoAllKV</a></li>
</ul>
<p>There are also <a href="/predicates/#auth">auth predicates</a>, which will allow
you to match a route based on the content of a token:</p>
<ul>
<li><code>JWTPayloadAnyKV()</code></li>
<li><code>JWTPayloadAllKV()</code></li>
</ul>
<p>These are not validating the tokens, which should be done separately
by the filters mentioned above.</p>
<h2 id="diagnosis-throttling-bandwidth-latency">Diagnosis - Throttling Bandwidth - Latency</h2>
<p>For diagnosis purpose there are filters that enable you to throttle
the bandwidth or add latency. For the full list of filters see our
<a href="https://godoc.org/github.com/zalando/skipper/filters/diag">diag filter godoc page</a>.</p>
<pre><code>bandwidth(30) // incoming in kb/s
backendBandwidth(30) // outgoing in kb/s
backendLatency(120) // in ms
</code></pre>
<h2 id="flow-id-to-trace-request-flows">Flow Id to trace request flows</h2>
<p>To trace request flows skipper can generate a unique Flow Id for every
HTTP request that it receives. You can then find the trace of the
request in all your access logs.  Skipper sets the X-Flow-Id header to
a unique value. Read more about this in our
<a href="https://godoc.org/github.com/zalando/skipper/filters/flowid">flowid filter godoc</a>.</p>
<pre><code> flowId("reuse")
</code></pre>
<h1 id="filters-reliability-features">Filters - reliability features</h1>
<p>Filters can modify http requests and responses. There are plenty of
things you can do with them.</p>
<h2 id="circuitbreaker">Circuitbreaker</h2>
<h3 id="consecutive-breaker">Consecutive Breaker</h3>
<p>The <a href="https://godoc.org/github.com/zalando/skipper/filters/circuit#NewConsecutiveBreaker">consecutiveBreaker</a>
filter is a breaker for the ingress route that open if the backend failures
for the route reach a value of N (in this example N=15), where N is a
mandatory argument of the filter and there are some more optional arguments
<a href="https://godoc.org/github.com/zalando/skipper/filters/circuit#NewConsecutiveBreaker">documented</a>:</p>
<pre><code>consecutiveBreaker(15)
</code></pre>
<p>The ingress spec would look like this:</p>
<pre><code>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    zalando.org/skipper-filter: consecutiveBreaker(15)
  name: app
spec:
  rules:
  - host: app-default.example.org
    http:
      paths:
      - backend:
          serviceName: app-svc
          servicePort: 80
</code></pre>
<h3 id="rate-breaker">Rate Breaker</h3>
<p>The <a href="https://godoc.org/github.com/zalando/skipper/filters/circuit#NewRateBreaker">rateBreaker</a>
filter is a breaker for the ingress route that open if the backend
failures for the route reach a value of N within a window of the last
M requests, where N (in this example 30) and M (in this example 300)
are mandatory arguments of the filter and there are some more optional arguments
<a href="https://godoc.org/github.com/zalando/skipper/filters/circuit#NewRateBreaker">documented</a>.</p>
<pre><code>rateBreaker(30, 300)
</code></pre>
<p>The ingress spec would look like this:</p>
<pre><code>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    zalando.org/skipper-filter: rateBreaker(30, 300)
  name: app
spec:
  rules:
  - host: app-default.example.org
    http:
      paths:
      - backend:
          serviceName: app-svc
          servicePort: 80
</code></pre>
<h2 id="ratelimits">Ratelimits</h2>
<p>There are two kind of ratelimits:</p>
<ol>
<li>Client side ratelimits are used to slow down login enumeration
attacks, that targets your login pages. This is a security protection
for DDOS or login attacks.</li>
<li>Service or backend side ratelimits are used to protect your
services due too much traffic. This can be used in an emergency
situation to make sure you calm down ingress traffic or in general if
you know how much calls per duration your backend is able to handle.</li>
</ol>
<p>Ratelimits are enforced per route.</p>
<p>More details you will find in <a href="https://godoc.org/github.com/zalando/skipper/filters/ratelimit">ratelimit package</a>
and <a href="https://godoc.org/github.com/zalando/skipper/dataclients/kubernetes">Kubernetes dataclient</a> documentation.</p>
<h3 id="client-ratelimits">Client Ratelimits</h3>
<p>The example shows 20 calls per hour per client, based on
X-Forwarded-For header or IP incase there is no X-Forwarded-For header
set, are allowed to each skipper instance for the given ingress.</p>
<pre><code>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    zalando.org/skipper-filter: localRatelimit(20, "1h")
  name: app
spec:
  rules:
  - host: app-default.example.org
    http:
      paths:
      - backend:
          serviceName: app-svc
          servicePort: 80
</code></pre>
<p>If you need to rate limit service to service communication and
you use Authorization headers to protect your backend from your
clients, then you can pass a 3 parameter to group clients by "Authorization
Header":</p>
<pre><code>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    zalando.org/skipper-filter: localRatelimit(20, "1h", "auth")
  name: app
spec:
  rules:
  - host: app-default.example.org
    http:
      paths:
      - backend:
          serviceName: app-svc
          servicePort: 80
</code></pre>
<h3 id="service-ratelimits">Service Ratelimits</h3>
<p>The example shows 50 calls per minute are allowed to each skipper
instance for the given ingress.</p>
<pre><code>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    zalando.org/skipper-filter: ratelimit(50, "1m")
  name: app
spec:
  rules:
  - host: app-default.example.org
    http:
      paths:
      - backend:
          serviceName: app-svc
          servicePort: 80
</code></pre>
<h2 id="shadow-traffic">Shadow Traffic</h2>
<p>If you want to test a new replacement of a production service with
production load, you can copy incoming requests to your new endpoint
and ignore the responses from your new backend. This can be done by
the <a href="https://godoc.org/github.com/zalando/skipper/filters/tee">tee() and teenf() filters</a>.</p>
<pre><code>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    zalando.org/skipper-filter: teenf("https://app-new.example.org")
  name: app
spec:
  rules:
  - host: app-default.example.org
    http:
      paths:
      - backend:
          serviceName: app-svc
          servicePort: 80
</code></pre>
<h1 id="predicates">Predicates</h1>
<p><a href="https://godoc.org/github.com/zalando/skipper/predicates">Predicates</a>
are influencing the route matching, which you might want to carefully
test before using it in production. This enables you to do feature
toggles or time based enabling endpoints.</p>
<p>You can use all kinds of <a href="https://godoc.org/github.com/zalando/skipper/predicates">predicates</a>
with <a href="https://godoc.org/github.com/zalando/skipper/filters">filters</a> together.</p>
<h2 id="feature-toggle">Feature Toggle</h2>
<p>Feature toggles are often implemented as query string to select a new
feature. Normally you would have to implement this in your
application, but Skipper can help you with that and you can select
routes with an ingress definition.</p>
<p>You create 2 ingresses that matches the same route, here host header
match to <code>app-default.example.org</code> and one ingress has a defined query
parameter to select the route to the alpha version deployment. If the
query string in the URL has <code>version=alpha</code> set, for example
<code>https://app-default.example.org/mypath?version=alpha</code>, the service
<code>alpha-svc</code> will get the traffic, if not <code>prod-svc</code>.</p>
<p>alpha-svc:</p>
<pre><code>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    zalando.org/skipper-predicate: QueryParam("version", "^alpha$")
  name: alpha-app
spec:
  rules:
  - host: app-default.example.org
    http:
      paths:
      - backend:
          serviceName: alpha-svc
          servicePort: 80
</code></pre>
<p>prod-svc:</p>
<pre><code>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: prod-app
spec:
  rules:
  - host: app-default.example.org
    http:
      paths:
      - backend:
          serviceName: prod-svc
          servicePort: 80
</code></pre>
<h2 id="ip-whitelisting">IP Whitelisting</h2>
<p>This ingress route will only allow traffic from networks 1.2.3.0/24 and 195.168.0.0/17</p>
<pre><code>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    zalando.org/skipper-predicate: Source("1.2.3.0/24", "195.168.0.0/17")
  name: app
spec:
  rules:
  - host: app-default.example.org
    http:
      paths:
      - backend:
          serviceName: app-svc
          servicePort: 80
</code></pre>
<h2 id="ab-test">A/B test</h2>
<p>Implementing A/B testing is heavy. Skipper can help you to do
that. You need to have a traffic split somewhere and have your
customers sticky to either A or B flavor of your application. Most
likely people would implement using cookies. Skipper can set a
<a href="https://godoc.org/github.com/zalando/skipper/filters/cookie">cookie with responseCookie()</a>
in a response to the client and the
<a href="https://godoc.org/github.com/zalando/skipper/predicates/cookie">cookie predicate</a>
can be used to match the route based on the cookie. Like this you can
have sticky sessions to either A or B for your clients.  This example
shows to have 10% traffic using A and the rest using B.</p>
<p>10% choice of setting the Cookie "flavor" to "A":</p>
<pre><code>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    zalando.org/skipper-predicate: Traffic(.1)
    zalando.org/skipper-filter: responseCookie("flavor, "A", 31536000)
  name: app
spec:
  rules:
  - host: app-default.example.org
    http:
      paths:
      - backend:
          serviceName: a-app-svc
          servicePort: 80
</code></pre>
<p>Rest is setting Cookie "flavor" to "B":</p>
<pre><code>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    zalando.org/skipper-filter: responseCookie("flavor, "B", 31536000)
  name: app
spec:
  rules:
  - host: app-default.example.org
    http:
      paths:
      - backend:
          serviceName: b-app-svc
          servicePort: 80
</code></pre>
<p>To be sticky, you have to create 2 ingress with predicate to match
routes with the cookie we set before. For "A" this would be:</p>
<pre><code>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    zalando.org/skipper-predicate: Cookie("flavor", /^A$/)
  name: app
spec:
  rules:
  - host: app-default.example.org
    http:
      paths:
      - backend:
          serviceName: a-app-svc
          servicePort: 80
</code></pre>
<p>For "B" this would be:</p>
<pre><code>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    zalando.org/skipper-predicate: Cookie("flavor", /^B$/)
  name: app
spec:
  rules:
  - host: app-default.example.org
    http:
      paths:
      - backend:
          serviceName: b-app-svc
          servicePort: 80
</code></pre>
<h1 id="blue-green-deployments">Blue-Green deployments</h1>
<p>To do blue-green deployments you have to have control over traffic
switching. Skipper gives you the opportunity to set weights to backend
services in your ingress specification. <code>zalando.org/backend-weights</code>
is a hash map, which key relates to the <code>serviceName</code> of the backend
and the value is the weight of traffic you want to send to the
particular backend. It works for more than 2 backends, but for
simplicity this example shows 2 backends, which should be the default
case for supporting blue-green deployments.</p>
<p>In the following example <strong>my-app-1</strong> service will get <strong>80%</strong> of the traffic
and <strong>my-app-2</strong> will get <strong>20%</strong> of the traffic:</p>
<pre><code>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: my-app
  labels:
    application: my-app
  annotations:
    zalando.org/backend-weights: |
      {"my-app-1": 80, "my-app-2": 20}
spec:
  rules:
  - host: my-app.example.org
    http:
      paths:
      - backend:
          serviceName: my-app-1
          servicePort: http
        path: /
      - backend:
          serviceName: my-app-2
          servicePort: http
        path: /
</code></pre>
<h1 id="chaining-filters-and-predicates">Chaining Filters and Predicates</h1>
<p>You can set multiple filters in a chain similar to the <a href="https://godoc.org/github.com/zalando/skipper/eskip">eskip format</a>.</p>
<pre><code>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    zalando.org/skipper-predicate: Cookie("flavor", /^B$/) &amp;&amp; Source("1.2.3.0/24", "195.168.0.0/17")
    zalando.org/skipper-filter: localRatelimit(50, "10m") -&gt; requestCookie("test-session", "abc")
  name: app
spec:
  rules:
  - host: app-default.example.org
    http:
      paths:
      - backend:
          serviceName: app-svc
          servicePort: 80
</code></pre>
<h1 id="controlling-https-redirect">Controlling HTTPS redirect</h1>
<p>Skipper Ingress can provide HTTP-&gt;HTTPS redirection. Enabling it and setting the status code used by default can
be done with the command line options: -kubernetes-https-redirect and -kubernetes-https-redirect-code. By using
annotations, this behavior can be overridden from the individual ingress specs for the scope of routes generated
based on these ingresses specs.</p>
<p>Annotations:</p>
<ul>
<li>zalando.org/skipper-ingress-redirect: the possible values are true or false. When the global HTTPS redirect is
  disabled, the value true enables it for the current ingress. When the global redirect is enabled, the value
  false disables it for the current ingress.</li>
<li>zalando.org/skipper-ingress-redirect-code: the possible values are integers 300 &lt;= x &lt; 400. Sets the redirect
  status code for the current ingress.</li>
</ul>
<p>Example:</p>
<pre><code>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    zalando.org/skipper-ingress-redirect: true
    zalando.org/skipper-ingress-redirect-code: 301
  name: app
spec:
  rules:
  - host: mobile-api.example.org
    http:
      paths:
      - backend:
          serviceName: app-svc
          servicePort: 80
</code></pre></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
