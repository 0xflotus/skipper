<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Ingress Controller Deployment - Skipper</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../..">Skipper</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="../..">Architecture</a>
                    </li>
                    <li >
                        <a href="../../deployments/">Deployments</a>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Data Clients <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../dataclients/eskip-file/">Eskip</a>
</li>
                            
<li >
    <a href="../../dataclients/etcd/">Etcd</a>
</li>
                            
<li >
    <a href="../../dataclients/inkeeper-api/">Inkeeper API</a>
</li>
                            
<li >
    <a href="../../dataclients/kubernetes/">Kubernetes</a>
</li>
                            
<li >
    <a href="../../dataclients/route-string/">Route String</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Kubernetes <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li class="active">
    <a href="./">Ingress Controller Deployment</a>
</li>
                            
<li >
    <a href="../ingress-usage/">Ingress Usage</a>
</li>
                        </ul>
                    </li>
                    <li >
                        <a href="../../plugins/">Plugins</a>
                    </li>
                    <li >
                        <a href="../../scripts/">Scripts</a>
                    </li>
                    <li >
                        <a href="../../operations/">Operations</a>
                    </li>
                    <li >
                        <a href="../../videos/">Videos</a>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="../../dataclients/route-string/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../ingress-usage/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#skipper-ingress-controller">Skipper Ingress Controller</a></li>
            <li><a href="#why-you-should-use-skipper-as-ingress-controller">Why you should use skipper as ingress controller?</a></li>
            <li><a href="#what-is-an-ingress-controller">What is an Ingress-Controller</a></li>
            <li><a href="#aws-deployment">AWS deployment</a></li>
            <li><a href="#baremetal-deployment">Baremetal deployment</a></li>
            <li><a href="#requirements">Requirements</a></li>
        <li class="main "><a href="#install-skipper-as-ingress-controller">Install Skipper as ingress-controller</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="skipper-ingress-controller">Skipper Ingress Controller</h1>
<p>This documentation is meant for for cluster operators and describes
how to install skipper as Ingress-Controller into your Kubernetes
Cluster.</p>
<h2 id="why-you-should-use-skipper-as-ingress-controller">Why you should use skipper as ingress controller?</h2>
<p>Baremetal loadbalancer perform really well, but the configuration is
not updated frequently and most of these installations are not meant
to rapidly change. With introducing kubernetes this will change and
there is a need of rapid changing http routers. Skipper is designed
for rapidly changing it's routing tree.</p>
<p>Cloud loadbalancers are fine to scale and to change, but does not
provide many features. Skipper has advanced resiliency and deployment
features, that you can use to enhance your environment. For example
ratelimits, circuitbreakers, blue-green deployments, shadow traffic
and <a href="../ingress-usage/">more</a>.</p>
<h2 id="what-is-an-ingress-controller">What is an Ingress-Controller</h2>
<p>Ingress-controllers are serving http requests into a kubernetes
cluster. Most of the time traffic will pass ingress got to a
kubernetes service IP which will forward the packets to kubernetes PODs
selected by the kubernetes service.
For having a successful ingress, you need to have a DNS name pointing
to some stable IP addresses that act as a loadbalancer.</p>
<p>Skipper as ingress-controller:</p>
<ul>
<li>cloud: deploy behind the cloud loadbalancer</li>
<li>baremetal: deploy behind your hardware/software loadbalancer and have all skipper as members in one pool.</li>
</ul>
<p>You would point your DNS entries to the
loadbalancer in front of skipper, for example automated using
<a href="https://github.com/kubernetes-incubator/external-dns">external-dns</a>.</p>
<h2 id="aws-deployment">AWS deployment</h2>
<p>In AWS, this could be an ALB with DNS pointing to the ALB. The ALB can
then point to an ingress-controller running on an EC2 node and uses
Kubernetes <code>hostnetwork</code> port specification in the POD spec.</p>
<p><img alt="ingress-traffic-flow" src="../../img/ingress-traffic-flow-aws.svg" /></p>
<h2 id="baremetal-deployment">Baremetal deployment</h2>
<p>In datacenter, baremetal environments, you probably have a hardware
loadbalancer or some haproxy or nginx setup, that serves most of your
production traffic and DNS points to these endpoints. For example
<code>*.ingress.example.com</code> could point to your virtual server IPs in front
of ingress. Skippers could be used as pool members, which do the http
routing. Your loadbalancer of choice could have a wildcard certificate
for <code>*.ingress.example.com</code> and DNS for this would point to your
loadbalancer. You can also automate DNS records with
<a href="https://github.com/kubernetes-incubator/external-dns">external-dns</a>,
if you for example use PowerDNS as provider and have a loadbalancer
controller that modifies the status field in ingress to your
loadbalancer virtual IP.</p>
<p><img alt="ingress-traffic-flow" src="../../img/ingress-traffic-flow-baremetal.svg" /></p>
<h2 id="requirements">Requirements</h2>
<p>In general for one endpoint you need, a DNS A/AAAA record pointing to
one or more loadbalancer IPs. Skipper is best used behind this
layer 4 loadbalancer to route and manipulate HTTP data.</p>
<p>minimal example:</p>
<ul>
<li>layer 4 loadbalancer has <code>1.2.3.4:80</code> as socket for a virtual server pointing to all skipper ingress</li>
<li><code>*.ingress.example.com</code> points to 1.2.3.4</li>
<li>ingress object with host entry for <code>myapp.ingress.example.com</code> targets a service type ClusterIP</li>
<li>service type ClusterIP has a selector that targets your PODs of your myapp deployment</li>
</ul>
<p>TLS example:</p>
<ul>
<li>same as before, but you would terminate TLS on your layer 4 loadbalancer</li>
<li>layer 4 loadbalancer has <code>1.2.3.4:443</code> as socket for a virtual server</li>
<li>you can use an automated redirect for all port 80 requests to https with <code>-kubernetes-https-redirect</code></li>
</ul>
<h1 id="install-skipper-as-ingress-controller">Install Skipper as ingress-controller</h1>
<p>You should have a base understanding of <a href="https://kubernetes.io">Kubernetes</a> and
<a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Ingress</a>.</p>
<p>Prerequisites: First you have to install skipper-ingress as for
example daemonset, create a deployment and a service.</p>
<p>We start to deploy skipper-ingress as a daemonset, use hostNetwork and
expose the TCP port 9999 on each Kubernetes worker node for incoming ingress
traffic.</p>
<pre><code>% cat skipper-ingress-ds.yaml
apiVersion: extensions/v1beta1
kind: DaemonSet
metadata:
  name: skipper-ingress
  namespace: kube-system
  labels:
    application: skipper-ingress
    version: v0.9.115
    component: ingress
spec:
  selector:
    matchLabels:
      application: skipper-ingress
  updateStrategy:
    type: RollingUpdate
  template:
    metadata:
      name: skipper-ingress
      labels:
        application: skipper-ingress
        version: v0.9.115
        component: ingress
      annotations:
        scheduler.alpha.kubernetes.io/critical-pod: ''
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: master
                operator: DoesNotExist
      tolerations:
      - key: CriticalAddonsOnly
        operator: Exists
      hostNetwork: true
      containers:
      - name: skipper-ingress
        image: registry.opensource.zalan.do/pathfinder/skipper:v0.9.115
        ports:
        - name: ingress-port
          containerPort: 9999
          hostPort: 9999
        args:
          - "skipper"
          - "-kubernetes"
          - "-kubernetes-in-cluster"
          - "-address=:9999"
          - "-proxy-preserve-host"
          - "-serve-host-metrics"
          - "-enable-ratelimits"
          - "-experimental-upgrade"
          - "-metrics-exp-decay-sample"
        resources:
          limits:
            cpu: 200m
            memory: 200Mi
          requests:
            cpu: 25m
            memory: 25Mi
        readinessProbe:
          httpGet:
            path: /kube-system/healthz
            port: 9999
          initialDelaySeconds: 5
          timeoutSeconds: 5
</code></pre>
<p>We now deploy a simple demo application serving html:</p>
<pre><code>% cat demo-deployment.yaml
apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: skipper-demo
spec:
  replicas: 2
  template:
    metadata:
      labels:
        application: skipper-demo
    spec:
      containers:
      - name: skipper-demo
        image: registry.opensource.zalan.do/pathfinder/skipper:v0.9.117
        args:
          - "skipper"
          - "-inline-routes"
          - "* -&gt; inlineContent(\"&lt;body style='color: white; background-color: green;'&gt;&lt;h1&gt;Hello!&lt;/h1&gt;\") -&gt; &lt;shunt&gt;"
        ports:
        - containerPort: 9090
</code></pre>
<p>We deploy a service type ClusterIP that we will select from ingress:</p>
<pre><code>% cat demo-svc.yaml
apiVersion: v1
kind: Service
metadata:
  name: sszuecs-demo
  labels:
    application: skipper-demo
spec:
  type: ClusterIP
  ports:
    - port: 80
      protocol: TCP
      targetPort: 9090
      name: external
  selector:
    application: sszuecs-demo
</code></pre>
<p>To deploy both, you have to run:</p>
<pre><code>% kubectl create -f demo-deployment.yaml
% kubectl create -f demo-svc.yaml
</code></pre>
<p>Now we have a skipper-ingress running as daemonset exposing the TCP
port 9999 on each worker node, a backend application running with 2
replicas that serves some html on TCP port 9090, and we expose a
cluster service on TCP port 80. Besides skipper-ingress, deployment
and service can not be reached from outside the cluster. Now we expose
the application with Ingress to the external network:</p>
<pre><code>% cat demo-ing.yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: skipper-demo
spec:
  rules:
  - host: skipper-demo.&lt;mydomain.org&gt;
    http:
      paths:
      - backend:
          serviceName: skipper-demo
          servicePort: 80
</code></pre>
<p>To deploy this ingress, you have to run:</p>
<pre><code>% kubectl create -f demo-ing.yaml
</code></pre>
<p>Skipper will configure itself for the given ingress, such that you can test doing:</p>
<pre><code>% curl -v -H"Host: skipper-demo.&lt;mydomain.org&gt;" http://&lt;nodeip&gt;:9999/
</code></pre>
<p>The next question you may ask is: how to expose this to your customers?</p>
<p>The answer depends on your setup and complexity requirements. In the
simplest case you could add one A record in your DNS <code>*.&lt;mydomain.org&gt;</code>
to your frontend loadbalancer IP that directs all traffic from <code>*.&lt;mydomain.org&gt;</code>
to all Kubernetes worker nodes on TCP port 9999.</p>
<p>A more complex setup we use in production and can be done with
something that configures your frontend loadbalancer, for example
<a href="https://github.com/zalando-incubator/kube-ingress-aws-controller">kube-aws-ingress-controller</a>,
and your DNS, <a href="https://github.com/kubernetes-incubator/external-dns">external-dns</a>
automatically.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '../..';</script>
        <script src="../../js/base.js"></script>
        <script src="../../search/require.js"></script>
        <script src="../../search/search.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td><kbd>&larr;</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td><kbd>&rarr;</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>


    </body>
</html>
