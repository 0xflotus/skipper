<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Ingress Backends - Skipper</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../..">Skipper</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="../..">Architecture</a>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Basics <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../filters/">Filters</a>
</li>
                            
<li >
    <a href="../../predicates/">Predicates</a>
</li>
                            
<li >
    <a href="../../scripts/">Scripts</a>
</li>
                            
<li >
    <a href="../../plugins/">Plugins</a>
</li>
                        </ul>
                    </li>
                    <li >
                        <a href="../../deployments/">Deployments</a>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Data Clients <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../dataclients/eskip-file/">Eskip</a>
</li>
                            
<li >
    <a href="../../dataclients/etcd/">Etcd</a>
</li>
                            
<li >
    <a href="../../dataclients/inkeeper-api/">Inkeeper API</a>
</li>
                            
<li >
    <a href="../../dataclients/kubernetes/">Kubernetes</a>
</li>
                            
<li >
    <a href="../../dataclients/route-string/">Route String</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Kubernetes <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../ingress-controller/">Ingress Controller Deployment</a>
</li>
                            
<li >
    <a href="../ingress-usage/">Ingress Usage</a>
</li>
                            
<li class="active">
    <a href="./">Ingress Backends</a>
</li>
                        </ul>
                    </li>
                    <li >
                        <a href="../../operations/">Operations</a>
                    </li>
                    <li >
                        <a href="../../videos/">Videos</a>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="../ingress-usage/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../../operations/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#kubernetes-backend-deployments">Kubernetes Backend Deployments</a></li>
            <li><a href="#kubernetes-race-condition-problem">Kubernetes Race Condition problem</a></li>
            <li><a href="#teardown-strategies">Teardown strategies</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="kubernetes-backend-deployments">Kubernetes Backend Deployments</h1>
<h2 id="kubernetes-race-condition-problem">Kubernetes Race Condition problem</h2>
<p>As described in <a href="https://github.com/zalando/skipper/issues/652">#652</a>,
there is a problem that exists in kubernetes, while terminating Pods.
Terminating Pods could be graceful, but the nature of distributed
environments will show failures, because not all components in the
distributed system changed already their state. When a Pod terminates,
the controller-manager has to update the <code>endpoints</code> of the kubernetes
<code>service</code>.  Additionally skipper has to get this endpoints
list. Skipper polls the kube-apiserver every <code>-source-poll-timeout=&lt;ms&gt;</code>,
which defaults to 3000.
Reducing this interval or implementing watch will only reduce the
timeframe, but not fix the underlying race condition.</p>
<p>Mitigation strategies can be different and the next section document
strategies for application developers to mitigate the problem.</p>
<h2 id="teardown-strategies">Teardown strategies</h2>
<p>An application that is target of an ingress can circumvent HTTP code
504s Gateway Timeouts with these strategies:</p>
<ol>
<li>use <a href="#pod-lifecycle-hooks">Pod lifecycle hooks</a></li>
<li>use a SIGTERM handler to switch <code>readinessProbe</code> to unhealthy and
exit later, or just wait for SIGKILL terminating the process.</li>
</ol>
<h3 id="pod-lifecycle-hooks">Pod Lifecycle Hooks</h3>
<p><a href="https://kubernetes.io/docs/tasks/configure-pod-container/attach-handler-lifecycle-event/#define-poststart-and-prestop-handlers">Kubernetes Pod Lifecycle
Hooks</a>
in the Pod spec can have a <code>preStop</code> command which executes for
example a binary. The following will execute the binary <code>sleep</code> with
argument <code>20</code> to wait 20 seconds before terminating the containers
within the Pod:</p>
<pre><code class="yaml">lifecycle:
  preStop:
    exec:
      command: [&quot;sleep&quot;,&quot;20&quot;]
</code></pre>

<p>20 seconds should be enough to fade your Pod out of the endpoints list
and skipper's routing table.</p>
<h3 id="sigterm-handling-in-containers">SIGTERM handling in Containers</h3>
<p>An application can implement a SIGTERM handler, that changes the
<code>readinessProbe</code> target to unhealthy for the application
instance. This will make sure it will be deleted from the endpoints
list and from skipper's routing table. Similar to <a href="#pod-lifecycle-hooks">Pod Lifecycle
Hooks</a> you could sleep 20 seconds and after that
terminate your application or you just wait until SIGKILL will cleanup
the instance after 60s.</p>
<pre><code class="go">go func() {
    var sigs chan os.Signal
    sigs = make(chan os.Signal, 1)
    signal.Notify(sigs, syscall.SIGTERM)
    for {
        select {
            case &lt;-sigs:
               healthCheck = unhealthy
               time.Sleep(20*time.Second)
               os.Exit(0)
        }
    }
}
</code></pre></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '../..';</script>
        <script src="../../js/base.js"></script>
        <script src="../../search/require.js"></script>
        <script src="../../search/search.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td><kbd>&larr;</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td><kbd>&rarr;</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>


    </body>
</html>
